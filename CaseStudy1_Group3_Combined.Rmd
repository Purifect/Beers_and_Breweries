---
title: "Case Study 1 by Group 3"
author: "Group 3 - Chris Roche, Puri Rudick, and Ryan Kinney"
output:
  html_document: default
  pdf_document: default
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(dplyr)
library(ggplot2)
library(stringr)
library(usmap)
library(ggnewscale)
library(caret)
library(class)
library(Rmisc)
library(gridExtra)
library(ggpubr)
```

### Read in the data from csv files
```{r}
beerDataOrig = read.csv("Beers.csv",header = TRUE)
breweryDataOrig = read.csv("Breweries.csv",header = TRUE)
```

### 1. How many breweries are present in each state?

The number of breweries in each state as shown below.
The darker color represents the higher number of breweries with number labeled.

The plot shows that Colorado has the most breweries in the country, which is 47 breweries.
```{r}
breweryDataOrig = as.data.frame(breweryDataOrig)

Breweries.in.each.state = count(breweryDataOrig$State)
names(Breweries.in.each.state)[1] <- "state"
Breweries.in.each.state$state <-
  str_replace_all(string=Breweries.in.each.state$state, 
                  pattern=" ", repl="")

centroid_labels <- 
  utils::read.csv(system.file("extdata",
                              paste0("us_", "states", "_centroids.csv"), 
                              package = "usmap"), stringsAsFactors = FALSE)

labels <- 
  merge(x = centroid_labels, 
        y = Breweries.in.each.state, 
        by.x = "abbr", 
        by.y = "state", 
        all.x=TRUE)

names(labels)[6] <- "breweries_count"

plot_usmap(data = Breweries.in.each.state, values = "freq", labels=FALSE) + 
  scale_fill_continuous(low = "white", 
                        high = "orange", 
                        name = "# of Breweries", 
                        label = scales::comma) + 
  theme(legend.position = "right") + 
  theme(panel.background = element_rect(colour = "black")) + 
  labs(title = "Number of Breweries by State") + 
  geom_text(data = labels, 
            ggplot2::aes(x = x, y = y, 
            label = scales::number(breweries_count,accuracy = 1)),
            color = "black")
```

### 2. Merge beer data with the breweries data.  Print the first 6 observations and the last six observations to check the merged file.

Beer and breweries data are merged using Brewery_ID as an index.

Below are first and last six observations on the merged beer dataset.
```{r}
mergedBeerData <- merge(x = beerDataOrig, y = breweryDataOrig,
                  by.x = "Brewery_id", by.y = "Brew_ID", all = TRUE)

names(mergedBeerData)[names(mergedBeerData)=="Name.x"] <- "Beer_name"
names(mergedBeerData)[names(mergedBeerData)=="Name.y"] <- "Brewery_name"

head(mergedBeerData)
tail(mergedBeerData)
```

### 3. Address the missing values in each column.

There are missing/empty values in three columns:

- ABV: 62 values missing
- IBU: 1,005 values missing, and
- Sty: 5 values missing

Totaling in 1,007 rows with missing value.
```{r}
mergedBeerData$Style <- 
  lapply(mergedBeerData$Style,
         function(x) if(identical(x,"")) NA else x)


sapply(mergedBeerData, function(x) sum(is.na(x)))

row.has.na <- apply(mergedBeerData, 1, function(x){any(is.na(x))})
sum(row.has.na)
```

After filtering the missing/empty values out of the merged beer dataset, there are 1,405 rows of data in total that we work with.
```{r}
# Filtered Merged Data
mergedBeerData.filtered <- mergedBeerData[!row.has.na,]

nrow(mergedBeerData.filtered)
```

### 4.Compute the median alcohol content and international bitterness unit for each state. Plot a bar chart to compare.

The median of Alcohol By Volume (ABV) and International Bitterness Units (IBU) for each state as shown below.

From the bar charts, Maine has the highest number for both ABV (0.067 or 6.7%) and IBU (61 unit).
```{r message = FALSE, warning = FALSE}
medianData <- aggregate(mergedBeerData.filtered[, 4:5], list(mergedBeerData.filtered$State), median)
names(medianData)[names(medianData)=="Group.1"] <- "State"

g.mid <- ggplot(medianData,aes(x=1, y = reorder(State,ABV))) +
  geom_text(aes(label=State)) +
  geom_segment(aes(x=0.94,xend=0.96,yend=State)) +
  geom_segment(aes(x=1.04,xend=1.062,yend=State)) +
  ggtitle("") +
  ylab(NULL) +
  scale_x_continuous(expand=c(0,0),limits=c(0.94,1.062)) +
  theme(axis.title=element_blank(),
        panel.grid=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        panel.background=element_blank(),
        axis.text.x=element_text(color=NA),
        axis.ticks.x=element_line(color=NA),
        plot.margin = unit(c(1,-1,1,-1), "mm"))

g1 <- ggplot(data = medianData, aes(x = reorder(State,ABV), y = ABV, label = ABV)) +
  geom_bar(stat = "identity", fill = "sandybrown") + 
  ggtitle("Alcohol By Volume (ABV)") +
  geom_text(aes(y = ABV+0.004), 
            size = 3,
            vjust = .5) +
  theme(panel.background = element_blank(),
        axis.title.x = element_blank(), 
        axis.text.x=element_text(color=NA),
        axis.ticks.x=element_line(color=NA),
        axis.title.y = element_blank(), 
        axis.text.y = element_blank(), 
        axis.ticks.y = element_blank(), 
        legend.position = "none",
        plot.title = element_text(hjust = 1),
        plot.margin = unit(c(1,0,1,0), "mm")) +
  scale_y_reverse() +
  coord_flip(ylim = c(0.075,0.03))

g2 <- ggplot(data = medianData, aes(x = reorder(State,ABV), y = IBU, fill = IBU, label = IBU)) +
  xlab(NULL) +
  geom_bar(stat = "identity") + 
  ggtitle("International Bitterness Units (IBU)") +
  geom_text(aes(y = IBU+3),
            size = 3,
            vjust = .5) +
  scale_fill_gradient2(low = "grey25", 
                       high = "black",
                       name = "IBU") +
  theme(panel.background = element_blank(),
        axis.title.x = element_blank(), 
        axis.text.x=element_text(color=NA),
        axis.ticks.x=element_line(color=NA),
        axis.title.y = element_blank(),
        axis.text.y = element_blank(), 
        axis.ticks.y = element_blank(),
        legend.position = "none",
        plot.margin = unit(c(1,5,1,0), "mm")) +
  coord_flip(ylim = c(5,65))

gg1 <- ggplot_gtable(ggplot_build(g1))
gg2 <- ggplot_gtable(ggplot_build(g2))
gg.mid <- ggplot_gtable(ggplot_build(g.mid))

grid.arrange(gg1,gg.mid,gg2,ncol=3,widths=c(4/9,1/9,4/9))
```

Combined the two bar charts together with radial stacked bar chart.
```{r}
medianData %>%
  ggplot(aes(x = reorder(State,ABV))) +
  geom_col(aes(y = ABV*1000, fill = ABV*100)) +
  scale_fill_gradient2(low = "white", 
                       high = "orange",
                       name = "ABV") +
  geom_text(aes(y = ABV*1000-8, label = round(ABV*100, 3)), color = "chocolate4", size = 3) +
  new_scale_fill() +
  geom_col(aes(y = -IBU, fill = IBU)) +
  scale_fill_gradient2(low = "grey25", 
                       high = "black",
                       name = "IBU") +
  geom_text(aes(y = -6, label = round(IBU, 3)), color = "white", size = 3) +
  geom_text(aes(y = ABV*1000+10, label = State)) + 
  scale_y_continuous(limits = c(-70, 80)) +
  coord_polar() +
  theme_void() +
  labs(title = "Median of Alcohol By Volume (ABV) and\nInternational Bitterness Units (IBU) for Each State",
       subtitle = "   * The bar chart ordered clockwise by ABV value\n   ** The darker color represents higher value of ABV and IBU")

```

### 5. Which state has the maximum alcoholic (ABV) beer? Which state has the most bitter (IBU) beer?

When consider the median value of ABV and IBU, Maine has the highest number for both ABV (0.067 or 6.7%) and IBU (61 unit).
```{r}
# arrange by ABV in descending order, print state for first observation
orderedABVmedian <- medianData %>% arrange(desc(ABV))
orderedABVmedian[1,]$State

orderedIBUmedian <- medianData %>% arrange(desc(IBU))
orderedIBUmedian[1,]$State
```
But when consider individual beer, 

- Kentucky has the highest number for ABV which is 0.125 or 12.5% from London Valling Beer and 
- Oregon has the highest value for IBU which is 138 unit from Bitter Bitch Imperial IPA.
```{r}
# arrange by ABV in descending order, print state for first observation
orderedABV <- mergedBeerData.filtered %>% arrange(desc(ABV))
orderedABV[1,]

orderedIBU <- mergedBeerData.filtered %>% arrange(desc(IBU))
orderedIBU[1,]
```

### 6. Comment on the summary statistics and distribution of the ABV variable.

- The range of ABV’s is from a minimum of 2.7% to a maximum of 12.5%
- The average ABV is 6% with a standard deviation of 1.3%
```{r}
mergedBeerData.filtered %>%
    summarize(mean=mean(ABV), 
              sd=sd(ABV), 
              median=median(ABV), 
              range=max(ABV)-min(ABV), 
              min(ABV), 
              max(ABV), 
              IQR=IQR(ABV))
```

### 7. Is there an apparent relationship between the bitterness of the beer and its alcoholic content? Draw a scatter plot.  Make your best judgment of a relationship and EXPLAIN your answer.

From the scatter plot with a regression line, there is a positive correlation between a beer’s ABV and its IBU.  There is strong evidence at the alpha = .05 level of significance to suggest that there is a linearly correlated relationship between a beer’s ABV and its IBU (p-value <.0001), with Pearson's Correlation Coefficient = 0.67 and r-square = 0.45.


```{r message = FALSE, warning = FALSE}
mergedBeerData.filtered %>%
  ggplot(aes(x = ABV,y = IBU)) + 
  geom_jitter() + 
  ggtitle("ABV vs. IBU") + 
  geom_smooth(method="lm", se=F) + 
  stat_cor(label.y = 150, 
           aes(label = paste(..rr.label.., 
                             ..p.label.., 
                             sep = "~`,`~"))) +
  stat_regline_equation(label.y = 145) +
  theme_bw()

cor.test(mergedBeerData.filtered$ABV,mergedBeerData.filtered$IBU)
```

### 8. Budweiser would also like to investigate the difference with respect to IBU and ABV between IPAs (India Pale Ales) and other types of Ale (any beer with “Ale” in its name other than IPA).  You decide to use KNN classification to investigate this relationship  Provide statistical evidence one way or the other. 
*You can of course assume your audience is comfortable with percentages … KNN is very easy to understand conceptually.*

```{r message = FALSE, warning = FALSE}
mergedBeerData.filtered$AleStyle <- 
  ifelse(grepl("IPA", mergedBeerData.filtered$Style, fixed = TRUE),"IPA",
         ifelse(grepl("Ale", mergedBeerData.filtered$Style, fixed = TRUE),"Ale","Other"))

mergedBeerData.filtered$AleByName <- 
  ifelse(grepl("India Pale Ale", mergedBeerData.filtered$Beer_name, fixed = TRUE),"IPA",
         ifelse(grepl("IPA", mergedBeerData.filtered$Beer_name, fixed = TRUE),"IPA",
                ifelse(grepl("Ale", mergedBeerData.filtered$Beer_name, fixed = TRUE),"Ale","Other")))

aleBeerFiltered <- mergedBeerData.filtered %>% filter(AleByName == "IPA" | AleByName == "Ale")

set.seed(4)
splitPerc = .7

trainIndices = sample(1:dim(aleBeerFiltered)[1], round(splitPerc * dim(aleBeerFiltered)[1]))
beerTrain = aleBeerFiltered[trainIndices,]
beerTest = aleBeerFiltered[-trainIndices,]

# run knn
classifications = knn(beerTrain[,4:5], beerTest[,4:5], beerTrain$AleByName, k = 5, prob = TRUE)
summary(classifications)

# Confusion Matrix
table(beerTest$AleByName, classifications)
CM = confusionMatrix(table(beerTest$AleByName, classifications))
CM

```

### 9. Knock their socks off!  Find one other useful inference from the data that you feel Budweiser may be able to find value in.  You must convince them why it is important and back up your conviction with appropriate statistical evidence. 
```{r}
set.seed(4)
splitPerc = .7

trainIndices.allType = sample(1:dim(mergedBeerData.filtered)[1], round(splitPerc * dim(mergedBeerData.filtered)[1]))
beerTrain.allType = mergedBeerData.filtered[trainIndices.allType,]
beerTest.allType = mergedBeerData.filtered[-trainIndices.allType,]

# run knn
classifications = knn(beerTrain.allType[,4:5], beerTest.allType[,4:5], beerTrain.allType$AleByName, k = 5, prob = TRUE)
summary(classifications)

# Confusion Matrix
table(beerTest.allType$AleByName, classifications)
CM.allType = confusionMatrix(table(beerTest.allType$AleByName, classifications))
CM.allType
```